# Лабораторная работа №5. Работа с базой данных

## Цель работы

Освоить архитектуру с единой точкой входа, подключение шаблонов для визуализации страниц, а также переход от хранения данных в файле к использованию базы данных (MySQL).

## Условия

Продолжите разработку проекта, начатого в предыдущей лабораторной работе, необходимо:

- Реализовать архитектуру с единой точкой входа (`index.php`), обрабатывающей все входящие HTTP-запросы.
- Настроить базовую систему шаблонов с использованием файла `layout.php` и отдельных представлений для разных страниц.
- Перенести логику работы с рецептами из файловой системы в базу данных (например, `MySQL`).

### Задание 1. Подготовка среды

1. Убедитесь, что на вашем компьютере установлен и корректно настроен сервер MySQL (например, `XAMPP`, `MAMP` или `LAMP`) или другой базы данных.
2. Создайте базу данных под названием `recipe_book`.
3. Создайте таблицу `recipes` со следующей структурой:

   ```sql
      CREATE TABLE recipes (
      id INT AUTO_INCREMENT PRIMARY KEY,
      title VARCHAR(255) NOT NULL,
      category INT NOT NULL,
      ingredients TEXT,
      description TEXT,
      tags TEXT,
      steps TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (category) REFERENCES categories(id) ON DELETE CASCADE
   );
   ```

4. Создайте таблицу `categories` со следующей структурой:

   ```sql
      CREATE TABLE categories (
      id INT AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(100) NOT NULL UNIQUE,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );
   ```

> [!NOTE]
> По желанию можно создать отдельные таблицы `steps` и `tags`, связав их с таблицей `recipes` с помощью внешних ключей.

1. _Дополнительное задание_. Рекомендуется использовать миграции для создания таблиц. Для этого можно применить сторонние библиотеки, например, `migrate` [^1].

### Задание 2. Архитектура и шаблонизация

1. В корневой папке `public/` создайте файл `index.php`, который будет служить основной точкой входа.
2. Настройте простейшую маршрутизацию, которая будет обрабатывать запросы к различным страницам приложения.
3. Создайте файл `templates/layout.php`, который будет базовым шаблоном для всех страниц.
4. Создайте шаблоны для следующих страниц:
   1. `index` — отображение всех рецептов;
   2. `create` — форма добавления рецепта;
   3. `recipe` — страница с подробной информацией о рецепте.

_Примечание_: вы можете использовать любой из рассмотренных на занятиях подходов к шаблонизации.

Рекомендованная структура проекта:

```
recipe-book/
├── public/
│   └── index.php
├── src/
│   ├── handlers/
│   │   ├── recipe/
│   │   │   ├── create.php
│   │   │   ├── edit.php
│   │   │   └── delete.php
│   ├── db.php
│   ├── helpers.php
├── config/
│   └── db.php
├── templates/
│   ├── layout.php
│   ├── index.php
│   └── recipe/
│       ├── create.php
│       ├── edit.php
│       └── show.php
├── .env                # При использовании .env-файла
└── README.md
```

### Задание 3. Подключение к базе данных

1. В файле `src/db.php` реализуйте функцию подключения к базе данных (_Рекомендуется использовать PDO_).
2. Храните параметры подключения `config/db.php`.
   1. _Доп. задание_: используйте файл `.env` для хранения подключения к базе данных.
3. Функция подключения должна возвращать экземпляр `PDO`, настроенный на выбрасывание исключений (`PDO::ERRMODE_EXCEPTION`).
   1. _Примечание_: при желании можно реализовать класс `Database` с методами `query()`, `insert()`, `find()` и т.д. для инкапсуляции работы с базой данных.

### Задание 3. Реализация CRUD-функциональности

1. Реализуйте обработчики следующих операций:
   1. Добавление рецепта (`handlers/recipe/create.php`);
   2. Редактирование рецепта (`handlers/recipe/edit.php`);
   3. Удаление рецепта (`handlers/recipe/delete.php`).
2. Все данные должны сохраняться и извлекаться из базы данных.
3. Обязательно реализуйте проверку и валидацию данных на стороне сервера.

### Задание 4. Защита от SQL-инъекций

1. Используйте подготовленные выражения для выполнения SQL-запросов, чтобы избежать SQL-инъекций.
2. Проверьте, что все входные данные корректно экранируются и валидируются перед выполнением запросов к базе данных.
3. Продемонстрируйте пример SQL-инъекции в вашем приложении и объясните, как вы её предотвратили.

### Задание 5. _Дополнительное задание_. Пагинация

1. Реализуйте пагинацию с использованием SQL-запросов LIMIT и OFFSET, отображая по 5 рецептов на странице (`page=2`, `page=3` и т.д.).

## Документация кода

Код должен быть корректно задокументирован, используя стандарт `PHPDoc`. Каждая функция и метод должны быть описаны с указанием их входных параметров, выходных данных и описанием функционала. Комментарии должны быть понятными, четкими и информативными, чтобы обеспечить понимание работы кода другим разработчикам.

## Контрольные вопросы

1. Какие преимущества даёт использование единой точки входа в веб-приложении?
2. Какие преимущества даёт использование шаблонов?
3. Какие преимущества даёт хранение данных в базе по сравнению с хранением в файлах?
4. Что такое SQL-инъекция? Придумайте пример SQL-инъекции и объясните, как её предотвратить.

[^1]: _migrate_. github.com. Available at: https://github.com/golang-migrate/migrate